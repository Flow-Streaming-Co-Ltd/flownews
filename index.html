<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow NEWS | #1 News Source</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cal+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #121212;
            --border-color: #e0e0e0;
            --accent-color: #121212; /* Main accent for links, active states */
            --sidebar-accent-color: #007bff; /* Specific accent for sidebar region/country active state */
            --header-bg: #f8f9fa;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --sidebar-bg: #ffffff;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --accent-color: #e0e0e0;
            --sidebar-accent-color: #6cb2f7;
            --header-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --card-shadow: 0 2px 8px rgba(255,255,255,0.05);
            --sidebar-bg: #1e1e1e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Inter", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-left .menu-icon,
        .header-right .theme-toggle-button .material-symbols-outlined {
            font-size: 28px; cursor: pointer; color: var(--text-color); transition: color 0.3s;
        }
        .header-left .menu-icon:hover,
        .header-right .theme-toggle-button:hover .material-symbols-outlined { color: var(--accent-color); }

        .logo-area { display: flex; flex-direction: column; align-items: center; }
        .logo { text-align: center; }
        .logo-flow { font-family: "Cal Sans", "Inter", sans-serif; font-size: 2.2em; font-weight: 700; letter-spacing: -0.5px; color: var(--text-color); transition: color 0.3s; }
        .logo-news { font-family: "Playfair Display", serif; font-size: 2em; font-weight: bold; margin-left: 5px; color: var(--text-color); transition: color 0.3s; }
        .header-date { font-size: 0.75em; color: var(--text-color); opacity: 0.7; margin-top: 2px; font-family: "Inter", sans-serif; font-weight: 400; }

        .theme-toggle-button { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }

        .sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, background-color 0.3s;
            z-index: 1100; padding: 20px; display: flex; flex-direction: column;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }
        .dark-mode .sidebar { box-shadow: 2px 0 10px rgba(255,255,255,0.05); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { display: flex; justify-content: flex-end; margin-bottom: 20px; flex-shrink: 0; }
        .close-menu-icon { font-size: 28px; cursor: pointer; color: var(--text-color); }
        .close-menu-icon:hover { color: var(--accent-color); }
        .sidebar-content { flex-grow: 1; overflow-y: auto; }

        .sidebar-search-container { margin-bottom: 20px; }
        .sidebar-search-input-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0 12px;
            background-color: var(--bg-color);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .dark-mode .sidebar-search-input-wrapper { background-color: var(--card-bg); }
        .sidebar-search-input-wrapper:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }
        .search-icon-prefix { margin-right: 8px; color: var(--text-color); opacity: 0.6; font-size: 22px; }
        .sidebar-search-input-wrapper input[type="search"] {
            flex-grow: 1; padding: 10px 0; border: none; background-color: transparent;
            color: var(--text-color); font-family: "Inter", sans-serif; font-size: 0.9em; outline: none;
        }
        .sidebar-search-input-wrapper input[type="search"]::-webkit-search-cancel-button,
        .sidebar-search-input-wrapper input[type="search"]::-webkit-search-decoration {
            -webkit-appearance: none; appearance: none;
        }

        .region-filter-container { margin-bottom: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .region-filter-container .region-main-toggle,
        .region-filter-container .continent-toggle {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; text-decoration: none; color: var(--text-color);
            font-weight: 700; font-size: 1.1em; cursor: pointer; transition: color 0.2s;
        }
        .region-filter-container .region-main-toggle:hover,
        .region-filter-container .continent-toggle:hover { color: var(--accent-color); }
        .region-filter-container .continent-toggle.active-continent,
        .region-filter-container .country-link.active-country { color: #000000; font-weight: bold; }
        .region-filter-container .toggle-icon { font-size: 20px; transition: transform 0.2s ease-in-out; }
        .region-filter-container .region-main-toggle.expanded .toggle-icon,
        .region-filter-container .continent-toggle.expanded .toggle-icon { transform: rotate(90deg); }
        .region-filter-container ul { list-style: none; padding-left: 0; }
        .region-filter-container .continent-list,
        .region-filter-container .country-list { display: none; padding-left: 15px; }
        .region-filter-container .continent-list.expanded,
        .region-filter-container .country-list.expanded { display: block; }
        .region-filter-container .country-link {
            display: block; padding: 8px 0; text-decoration: none;
            color: var(--text-color); font-size: 0.95em; transition: color 0.2s; padding-left: 10px;
        }
        .region-filter-container .country-link:hover { color: var(--accent-color); }

        .sidebar-nav { border-top: 1px solid var(--border-color); padding-top: 15px; }
        .sidebar-nav ul { list-style: none; }
        .sidebar-nav li a { display: block; padding: 12px 0; text-decoration: none; color: var(--text-color); font-weight: 700; font-size: 1.1em; transition: color 0.2s; }
        .sidebar-nav li a:hover { color: var(--accent-color); }
        .flow-plus-link { font-family: "Cal Sans", "Inter", sans-serif; font-weight: 700; }
        .flow-plus-link .plus-symbol { color: black; font-weight: bold; }
        .dark-mode .flow-plus-link .plus-symbol { color: white; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1050;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .overlay.active { opacity: 1; visibility: visible; }

        .category-nav {
            background-color: var(--bg-color); border-bottom: 1px solid var(--border-color);
            padding: 10px 0; overflow-x: auto; white-space: nowrap;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .category-nav ul { list-style-type: none; display: flex; justify-content: center; padding-left: 20px; padding-right: 20px; }
        .category-nav li { margin: 0 15px; }
        .category-nav a { text-decoration: none; color: var(--text-color); font-weight: 500; padding-bottom: 8px; position: relative; transition: color 0.3s; }
        .category-nav a:hover { color: var(--accent-color); }
        .category-nav a.active { font-weight: bold; color: var(--accent-color); }
        .category-nav a.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background-color: var(--accent-color); }

        #news-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; flex-grow: 1; }
        .loading-message, .error-message, .results-title {
            text-align: center; font-size: 1.2em; padding: 40px 20px; color: var(--text-color);
        }
        .results-title { padding: 20px 20px 0; font-family: "Playfair Display", serif; font-weight: bold; }

        .news-article {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 25px; padding: 20px;
            box-shadow: var(--card-shadow); overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        .news-article img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 15px; display: block; }
        .news-article h2 { font-family: "Playfair Display", serif; font-size: 1.8em; margin-bottom: 10px; color: var(--text-color); transition: color 0.3s; }
        .news-article h2 a { text-decoration: none; color: inherit; }
        .news-article h2 a:hover { color: var(--accent-color); text-decoration: underline; }
        .news-article p.description { margin-bottom: 15px; font-size: 0.95em; color: var(--text-color); opacity: 0.85; transition: color 0.3s, opacity 0.3s; }
        .article-meta { font-size: 0.8em; color: var(--text-color); opacity: 0.7; margin-bottom: 10px; transition: color 0.3s, opacity 0.3s; }
        .article-meta span { margin-right: 15px; }
        .read-more { display: inline-block; color: var(--accent-color); text-decoration: none; font-weight: bold; }
        .read-more:hover { text-decoration: underline; }

        footer {
            text-align: center; padding: 20px; border-top: 1px solid var(--border-color);
            background-color: var(--header-bg); color: var(--text-color);
            font-size: 0.9em; transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        footer p { margin-bottom: 5px; }

        @media (max-width: 768px) {
            .logo-flow { font-size: 1.8em; } .logo-news { font-size: 1.6em; } .header-date { font-size: 0.7em; }
            header { padding: 10px 15px; }
            .category-nav ul { justify-content: flex-start; }
            .news-article h2 { font-size: 1.5em; } #news-container { padding: 0 10px; }
            .sidebar { width: 250px; }
        }
        @media (max-width: 480px) { .category-nav li { margin: 0 10px; } }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <span class="material-symbols-outlined menu-icon" id="menu-toggle-button">menu</span>
        </div>
        <div class="logo-area">
            <div class="logo">
                <span class="logo-flow">ƒIow</span>
                <span class="logo-news">NEWS</span>
            </div>
            <p id="current-date" class="header-date"></p>
        </div>
        <div class="header-right">
            <button id="theme-toggle" class="theme-toggle-button" aria-label="Toggle dark mode">
                <span class="material-symbols-outlined">light_mode</span>
            </button>
        </div>
    </header>

    <div id="sidebar-menu" class="sidebar">
        <div class="sidebar-header">
            <span class="material-symbols-outlined close-menu-icon" id="close-menu-button">close</span>
        </div>
        <div class="sidebar-content">
            <form id="sidebar-search-form" class="sidebar-search-container" role="search">
                <div class="sidebar-search-input-wrapper">
                    <span class="material-symbols-outlined search-icon-prefix">search</span>
                    <input type="search" id="sidebar-search-input" placeholder="Search news..." aria-label="Search news">
                </div>
                <button type="submit" style="display:none;" aria-hidden="true">Search</button>
            </form>

            <div id="region-filter" class="region-filter-container"></div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="about_us.html">About Us</a></li>
                    <li><a href="https://arbiepeligro.github.io/flowplus.ph" target="_blank" rel="noopener noreferrer" class="flow-plus-link">ƒIow<span class="plus-symbol">+</span></a></li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="overlay" class="overlay"></div>

    <nav class="category-nav">
        <ul>
            <li><a href="#" data-category="general" class="active">TOP</a></li>
            <li><a href="#" data-category="world">World</a></li>
            <li><a href="#" data-category="nation">Nation</a></li>
            <li><a href="#" data-category="business">Business</a></li>
            <li><a href="#" data-category="technology">Technology</a></li>
            <li><a href="#" data-category="entertainment">Entertainment</a></li>
            <li><a href="#" data-category="sports">Sports</a></li>
            <li><a href="#" data-category="science">Science</a></li>
            <li><a href="#" data-category="health">Health</a></li>
        </ul>
    </nav>

    <main id="news-container">
        <p class="loading-message">Loading news...</p>
    </main>

    <footer>
        <p>© <span id="current-year"></span> Flow Streaming Co., Ltd. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY = 'efefd622-9ef0-46bc-b2c7-b5601b6d8f42'; // Webz.io API Key
            const NEWS_API_URL_BASE = 'https://api.webz.io/newsApiLite'; // Webz.io News API Lite endpoint

            const newsContainer = document.getElementById('news-container');
            const categoryNavList = document.querySelector('.category-nav ul');
            const themeToggleButton = document.getElementById('theme-toggle');
            const themeIcon = themeToggleButton.querySelector('.material-symbols-outlined');
            const currentDateHeaderElement = document.getElementById('current-date');
            const currentYearElement = document.getElementById('current-year');

            const menuToggleButton = document.getElementById('menu-toggle-button');
            const sidebarMenu = document.getElementById('sidebar-menu');
            const closeMenuButton = document.getElementById('close-menu-button');
            const overlay = document.getElementById('overlay');
            const sidebarSearchForm = document.getElementById('sidebar-search-form');
            const sidebarSearchInput = document.getElementById('sidebar-search-input');
            const regionFilterContainer = document.getElementById('region-filter');

            let currentCategory = 'general';
            let currentSearchQuery = '';
            let currentContinentQuery = '';
            let currentCountryCode = '';
            let currentCountryName = '';


            const regionsAndCountriesData = {
                "Asia": { "China": "cn", "India": "in", "Japan": "jp", "South Korea": "kr", "Indonesia": "id", "Saudi Arabia": "sa", "Singapore": "sg", "UAE": "ae", "Philippines": "ph", "Thailand": "th", "Vietnam": "vn", "Israel": "il", "Turkey": "tr" },
                "Africa": { "Egypt": "eg", "Nigeria": "ng", "South Africa": "za", "Kenya": "ke", "Morocco": "ma", "Algeria": "dz", "Ghana": "gh" },
                "North America": { "United States": "us", "Canada": "ca", "Mexico": "mx" },
                "South America": { "Brazil": "br", "Argentina": "ar", "Colombia": "co", "Peru": "pe", "Chile": "cl", "Venezuela": "ve" },
                "Europe": { "United Kingdom": "gb", "Germany": "de", "France": "fr", "Italy": "it", "Spain": "es", "Russia": "ru", "Netherlands": "nl", "Switzerland": "ch", "Sweden": "se", "Norway": "no", "Poland": "pl", "Belgium": "be", "Austria": "at", "Ireland": "ie", "Portugal": "pt", "Ukraine": "ua" },
                "Oceania": { "Australia": "au", "New Zealand": "nz" } // Changed from Antarctica
            };

            function setInitialTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeIcon.textContent = 'dark_mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeIcon.textContent = 'light_mode';
                }
            }

            themeToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                themeIcon.textContent = isDarkMode ? 'dark_mode' : 'light_mode';
            });

            function displayDate() {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                if (currentDateHeaderElement) {
                    currentDateHeaderElement.textContent = today.toLocaleDateString(undefined, options);
                }
                currentYearElement.textContent = today.getFullYear();
            }

            function openSidebar() { sidebarMenu.classList.add('open'); overlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
            function closeSidebar() { sidebarMenu.classList.remove('open'); overlay.classList.remove('active'); document.body.style.overflow = ''; }

            if (menuToggleButton) menuToggleButton.addEventListener('click', openSidebar);
            if (closeMenuButton) closeMenuButton.addEventListener('click', closeSidebar);
            if (overlay) overlay.addEventListener('click', closeSidebar);

            sidebarSearchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const searchTerm = sidebarSearchInput.value.trim();
                if (searchTerm) {
                    currentSearchQuery = searchTerm;
                    currentCategory = null; currentContinentQuery = ''; currentCountryCode = ''; currentCountryName = '';
                    updateActiveStates(); fetchNews(); sidebarSearchInput.value = ''; closeSidebar();
                } else {
                    currentSearchQuery = '';
                    if (!currentCategory && !currentContinentQuery && !currentCountryCode) currentCategory = 'general';
                    updateActiveStates(); fetchNews(); closeSidebar();
                }
            });

            function populateRegionsMenu() {
                if (!regionFilterContainer) return;
                let html = `<a href="#" class="region-main-toggle" id="region-main-toggler">Region <span class="material-symbols-outlined toggle-icon">chevron_right</span></a>`;
                html += `<ul class="continent-list" id="continents-ul">`;
                for (const continent in regionsAndCountriesData) {
                    html += `<li><a href="#" class="continent-toggle" data-continent="${continent}">${continent} <span class="material-symbols-outlined toggle-icon">chevron_right</span></a><ul class="country-list">`;
                    for (const countryName in regionsAndCountriesData[continent]) {
                        const countryCode = regionsAndCountriesData[continent][countryName];
                        html += `<li><a href="#" class="country-link" data-country-code="${countryCode}" data-country-name="${countryName}" data-parent-continent="${continent}">${countryName}</a></li>`;
                    }
                    html += `</ul></li>`;
                }
                html += `</ul>`;
                regionFilterContainer.innerHTML = html;

                document.getElementById('region-main-toggler').addEventListener('click', function(e) {
                    e.preventDefault(); this.classList.toggle('expanded'); document.getElementById('continents-ul').classList.toggle('expanded');
                });
                regionFilterContainer.querySelectorAll('.continent-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        const continentName = this.dataset.continent;
                        const alreadyExpanded = this.classList.contains('expanded');
                        regionFilterContainer.querySelectorAll('.country-list.expanded').forEach(cl => cl.classList.remove('expanded'));
                        regionFilterContainer.querySelectorAll('.continent-toggle.expanded').forEach(ct => { if (ct !== this) ct.classList.remove('expanded'); });
                        if (!alreadyExpanded) { this.classList.add('expanded'); this.nextElementSibling.classList.add('expanded'); }
                        else { this.classList.remove('expanded'); this.nextElementSibling.classList.remove('expanded'); }
                        
                        currentContinentQuery = continentName; currentCountryCode = ''; currentCountryName = ''; currentCategory = null; currentSearchQuery = '';
                        updateActiveStates(); fetchNews();
                    });
                });
                regionFilterContainer.querySelectorAll('.country-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentCountryCode = this.dataset.countryCode; currentCountryName = this.dataset.countryName;
                        currentContinentQuery = this.dataset.parentContinent; currentCategory = null; currentSearchQuery = '';
                        updateActiveStates(); fetchNews(); closeSidebar();
                    });
                });
            }
            
            async function fetchNews() {
                newsContainer.innerHTML = '<p class="loading-message">Loading news...</p>';
                let query = '';
                let fetchDescription = "Latest News";
                const pageSize = 10;
                let sortMethod = 'relevancy'; // Default sort for general searches

                if (currentCountryCode && currentCountryName) {
                    query = `(${currentCountryName} OR "${currentCountryName}") thread.country:${currentCountryCode.toUpperCase()}`;
                    fetchDescription = `News in ${currentCountryName}`;
                    sortMethod = 'published'; // Sort by published for country-specific news
                } else if (currentContinentQuery) {
                    query = currentContinentQuery;
                    fetchDescription = `News about ${currentContinentQuery}`;
                    sortMethod = 'relevancy';
                } else if (currentSearchQuery) {
                    query = currentSearchQuery;
                    fetchDescription = `Search results for: "${currentSearchQuery}"`;
                    sortMethod = 'relevancy';
                } else if (currentCategory) {
                    const catLink = categoryNavList.querySelector(`a[data-category="${currentCategory}"]`);
                    fetchDescription = catLink ? `${catLink.textContent} News` : "Top News";
                    if (currentCategory === 'general') {
                         query = 'top news'; // A broad query for general/top news
                         fetchDescription = "Top News";
                    } else if (currentCategory === 'world' || currentCategory === 'nation') {
                        query = currentCategory + " news"; // e.g., "world news"
                    }
                    else {
                        query = currentCategory; // e.g., "business", "technology"
                    }
                    sortMethod = 'published'; // Sort by published for categories
                } else {
                    currentCategory = 'general';
                    query = 'top news';
                    fetchDescription = "Top News";
                    sortMethod = 'published';
                }
                
                const url = `${NEWS_API_URL_BASE}?token=${API_KEY}&format=json&q=${encodeURIComponent(query)}&language=english&size=${pageSize}&sort=${sortMethod}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    // Webz.io success usually means data.posts exists. Errors might be in data.message or just a non-200 status.
                    if (!response.ok || !data.posts) { // Check if posts array exists
                        const errorMessage = data.message || `API request failed with status ${response.status}. Requests left: ${data.requestsLeft !== undefined ? data.requestsLeft : 'N/A'}`;
                        throw new Error(errorMessage);
                    }
                    displayNews(data.posts, fetchDescription);
                } catch (error) {
                    console.error('Error fetching news from Webz.io:', error);
                    newsContainer.innerHTML = `<p class="error-message">Failed to load news. ${error.message}.</p>`;
                }
            }

            function displayNews(articles, title) {
                newsContainer.innerHTML = '';
                if (title) {
                    const titleElement = document.createElement('h1');
                    titleElement.classList.add('results-title');
                    titleElement.textContent = title;
                    newsContainer.appendChild(titleElement);
                }

                if (!articles || articles.length === 0) {
                    newsContainer.appendChild(Object.assign(document.createElement('p'), {
                        className: 'loading-message', textContent: 'No articles found.'
                    }));
                    return;
                }

                articles.forEach(post => {
                    if (!post.title || !post.url) return;
                    const articleElement = document.createElement('article');
                    articleElement.classList.add('news-article');
                    
                    // Webz.io image: post.thread.main_image
                    let imageHtml = post.thread && post.thread.main_image ? `<img src="${post.thread.main_image}" alt="${post.title || ''}" onerror="this.style.display='none';">` : '';
                    
                    let publishedDate = 'N/A';
                    // Webz.io published: post.published
                    if (post.published) {
                        try {
                            publishedDate = new Date(post.published).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        } catch(e) { publishedDate = post.published; }
                    }

                    // Webz.io description: post.text
                    const description = post.text || 'No description available.';
                    const truncatedDescription = description.length > 200 ? description.substring(0, 200) + '...' : description;
                    
                    // Webz.io source: post.thread.site or post.author
                    const sourceName = (post.thread && post.thread.site) ? post.thread.site : (post.author || 'N/A');

                    articleElement.innerHTML = `
                        ${imageHtml}
                        <h2><a href="${post.url}" target="_blank" rel="noopener noreferrer">${post.title}</a></h2>
                        <div class="article-meta">
                            <span>Source: ${sourceName}</span>
                            <span>Published: ${publishedDate}</span>
                        </div>
                        <p class="description"></p>
                        <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="read-more">Read more →</a>
                    `;
                    newsContainer.appendChild(articleElement);
                });
            }

            function updateActiveStates() {
                categoryNavList.querySelectorAll('a').forEach(link => {
                    link.classList.toggle('active', link.dataset.category === currentCategory && !currentCountryCode && !currentContinentQuery && !currentSearchQuery);
                });

                if(regionFilterContainer) {
                    regionFilterContainer.querySelectorAll('.continent-toggle, .country-link').forEach(link => link.classList.remove('active-continent', 'active-country'));
                    if (currentCountryCode) {
                        const activeCountryLink = regionFilterContainer.querySelector(`.country-link[data-country-code="${currentCountryCode}"]`);
                        if (activeCountryLink) {
                            activeCountryLink.classList.add('active-country');
                            const parentContinentToggle = activeCountryLink.closest('ul.country-list')?.previousElementSibling; // Might need .expanded if list is not kept open
                             if (parentContinentToggle && parentContinentToggle.classList.contains('continent-toggle')) {
                                parentContinentToggle.classList.add('active-continent');
                            }
                        }
                    } else if (currentContinentQuery && !currentCountryCode) {
                        const activeContinentToggle = regionFilterContainer.querySelector(`.continent-toggle[data-continent="${currentContinentQuery}"]`);
                        if (activeContinentToggle) activeContinentToggle.classList.add('active-continent');
                    }
                }
            }

            categoryNavList.addEventListener('click', (event) => {
                event.preventDefault();
                const targetLink = event.target.closest('a');
                if (targetLink && targetLink.dataset.category) {
                    const newCategory = targetLink.dataset.category;
                    if (newCategory !== currentCategory || currentSearchQuery || currentContinentQuery || currentCountryCode) {
                        currentCategory = newCategory;
                        currentSearchQuery = ''; currentContinentQuery = ''; currentCountryCode = ''; currentCountryName = '';
                        updateActiveStates(); fetchNews();
                    }
                }
            });

            setInitialTheme();
            displayDate();
            populateRegionsMenu();
            updateActiveStates();
            fetchNews();
        });
    </script>
</body>
</html>
